<!DOCTYPE html>
<html>
<head>
  <title>video tripz</title>
  <style>
    video {
      display:none;
    }
    canvas {
      background: transparent;
    }
  </style>

  <script type="text/template" id="variable-filter">
    <form oninput="level.value = {{=it.name}}.valueAsNumber;">
      <input class="filter" type="checkbox" name="filter"/>{{=it.name}}
      <input type="range" min="{{=it.min}}" max="{{=it.max}}" id="{{=it.name}}-filter" name="{{=it.name}}" value="{{=it.currentValue}}" step="{{=it.step}}" class="variable-filter"/>
      <output style="margin-left: 20px; padding:14px;" for="{{=it.name}}-filter" name="level">{{=it.currentValue}}</output>
    </form>
  </script>

  <script type="text/template" id="fixed-filter">
    <input class="filter" type="checkbox" name="filter" value="{{=it.name}}">{{=it.name}}<br>
  </script>

  <!-- <script type="text/template" id="convolver">
    <button class="convolver {{=it.active}}" value='{{=it.name}}'>{{=it.name}}</button></br>
  </script> -->

  <script src="build.js"></script>
  <script src='js/lib/LinkedList.js'></script>
  <script src='js/dot.js'></script>

  <script src="js/services.js"></script>


  <script src="js/models/convolver.js"></script>
  <script src="js/models/saturation-filter.js"></script>
  <script src="js/models/sepia-filter.js"></script>
  <script src="js/models/threshold-filter.js"></script>
  <script src="js/models/low-res.js"></script>
  <script src="js/models/xor-filter.js"></script>
  <script src="js/models/median-filter.js"></script>
  <script src="js/models/sobel-filter.js"></script>
  <script src="js/models/laplace.js"></script>
  <script src="js/models/sharpen.js"></script>
  <script src="js/models/blur.js"></script>
  <script src="js/models/emboss.js"></script>

  <script src="js/collections/filter-collection.js"></script>

  <script src="js/views/filter-view.js"></script>
  <script src="js/views/variable-filter.js"></script>

  <script src="js/views/filter-collection-view.js"></script>

  <script src="js/views/CanvasView.js"></script>
  <script src="js/controllers/AppController.js"></script>
</head>
<body>
  <video id="camera-input"></video>
  <canvas width="480" height="360"></canvas>
  <br>
  <div style='float:right; margin-right:200px;'>
    <div id='cc'></div>
  </div>
  <div>
    <button id="snapshot">Take a Photo</button>
    <form name='canvas-blur' oninput="level.value = canvasBlur.valueAsNumber;">
      <label for="canvasBlur">Blur</label>
      <input type="range" min="0.0" max="1.0" step="0.1" id="canvasBlur" name="canvasBlur" value="1.0"/>
      <output for="canvasBlur" name="level">1.0</output>
    </form>

    <button id="stop">Stop</button>
    <button id="feedback">Feedback</button>
    <button id="reset">Reset</button>

    <button id='loop'>Store last second of video</button>

    <div class='filters'>
      <br><br>
      <div style="float: left; margin-left: 20px; margin-right: 20px;">
        <h4>Fixed Filters</h4>
        <div id='grayscale'></div>
        <div id='invert'></div>
        <div id='sepia'></div>
        <div id='emboss'></div>
        <div id='low-res'></div>
        <div id='bayer'></div>
        <div id='xor'></div>
        <div id='and'></div>
      </div>

      <div style="float: left; margin-left: 20px; margin-right: 20px;">
        <h4>Variable Filters</h4>

        <div id='contrast'></div>
        <div id='brightness'></div>
        <div id='saturation'></div>
        <div id='threshold'></div>
        <div id='median'></div>
      </div>

      <div style="float: left; margin-left: 20px; margin-right: 20px;">
        <h4>Convolvers</h4>

        <div id='sobel'></div>
        <div id='laplace'></div>
        <div id='sharpen'></div>
        <div id='blur'></div>
        <div id='embossC'></div>
      </div>
    </div>

    <div id="image-data">
      <img src='' id="image-preview" height="150" width="150"/>
      <input type="file" id="file-upload" accept="image/gif, image/jpeg, image/png"/>
    </div>

  </div>

  <script>
    var gsf = new GrayscaleFilter();
    var bf = new BrightnessFilter();
    var cf = new ContrastFilter();
    var sf = new SaturationFilter();
    var ivf = new InversionFilter();
    var spf = new SepiaFilter();
    var ef = new EmbossFilter();
    var tf = new ThresholdFilter();
    var byf = new BayerFilter();
    var lrf = new LowResFilter();
    var xof = new XORFilter();
    var and = new AndFilter();
    var mdf = new MedianFilter();
    var sbf = new SobelFilter();
    var lpf = new LaplaceFilter();
    var shf = new SharpenFilter();
    var blf = new BlurFilter();
    var ebc = new EmbossConvolver();

    var filterCollection = new FilterCollection({
      models: [gsf, cf, bf, sf, ivf, spf, ef, tf, byf, lrf, xof, mdf, sbf, lpf,shf,blf,ebc, and]
    });

    // Fixed Filters
    new FixedFilterView({el: '#grayscale', model: gsf}).render();
    new FixedFilterView({el: '#sepia', model: spf}).render();
    new FixedFilterView({el: '#invert', model: ivf}).render();
    new FixedFilterView({el: '#emboss', model: ef}).render();
    new FixedFilterView({el: '#low-res', model: lrf}).render();
    new FixedFilterView({el: '#bayer', model: byf}).render();
    new FixedFilterView({el: '#xor', model: xof}).render();
    new FixedFilterView({el: '#and', model: and}).render();

    new VariableFilterView({el: '#saturation', model: sf}).render();
    new VariableFilterView({el: '#contrast', model: cf}).render();
    new VariableFilterView({el: '#brightness', model: bf}).render();
    new VariableFilterView({el: '#threshold', model: tf}).render();
    new VariableFilterView({el: '#median', model: mdf}).render();

    new ConvolutionFilterView({el: '#sobel', model: sbf}).render();
    new ConvolutionFilterView({el: '#laplace', model: lpf}).render();
    new ConvolutionFilterView({el: '#sharpen', model: shf}).render();
    new ConvolutionFilterView({el: '#blur', model: blf}).render();
    new ConvolutionFilterView({el: '#embossC', model: ebc}).render();

    var hdConstraints = {
      video: {
        mandatory: {
          minWidth: 1280,
          minHeight: 720
        }
      }
    };

    var sdConstraints = {
      video: {
        mandatory: {
          minWidth: 480,
          minHeight: 360
        }
      }
    };

    function AppController() {
      // sub view representing the canvas element
      this.canvasView = null;
      // subview representing the filter nodes
      this.filtersView = new FilterCollectionView({
        el: '.filters',
        collection: filterCollection
      });

      this.allowedAccessToCamera = false;

      // Pointer to the current animation frame handler
      this.rfid = null;

      this.initialize();
    };

    AppController.prototype.initialize = function() {
      Services.UserMedia.getVideoStream(this.onAfterStreamRequest.bind(this));
    };

    AppController.prototype.onAfterStreamRequest = function(stream) {
      if (!stream) {
        return console.log('User denied access to their webcam.');
      }

      this.allowedAccessToCamera = true;

      this.canvasView = new CanvasView(document.querySelector('canvas'), stream);
      this.canvasView.on('ON_VIDEO_LOAD', this.startAnimationLoop.bind(this));
    };

    AppController.prototype.startAnimationLoop = function() {
      var self = this;

      function animationCallback() {
        glitch(self.canvasView.getDataURL(), self.canvasView.draw.bind(self.canvasView));
        var transformedData = self.filtersView.process(self.canvasView.getPixels());


        var shouldKeepDrawing = self.canvasView.draw(transformedData);

         if (!shouldKeepDrawing) {
           window.cancelAnimationFrame(self.rfid);
           self.rfid = null;
           return;
         }
         window.setTimeout(function() {
          self.rfid = window.requestAnimationFrame(animationCallback);
        }, 500);
      }

      this.rfid = window.requestAnimationFrame(animationCallback);
    };

    // stolen from errorzero
    function glitch(dataUrl, callback) {
      // These are the characters that will be randomly replaced in the image
      var charSets = [
        ["0",")","<",">",".","*","&","Â£","%","~","#","+","a","!","|","-"],
			  ["a","b","c","d","e","f","z","x","v","n","m","o","i","y","q","w"]
      ];
      var chunkSizes = ["64", "128", "256", "1024", "1024"];
      var chunks = [];

      var glitchChars = charSets[(Math.random() * 1 + 1) | 0];
      var chunkSize = chunkSizes[(Math.random() * 5 + 1) | 0];

      var decodedData = atob(dataUrl.replace('data:image/jpeg;base64,', ''));
      var chunk = parseInt((decodedData.length - 1) / chunkSize);
      var chunks = [];
      for (var i = 0, charsLength = decodedData.length; i < charsLength; i += chunk) {
        chunks.push(decodedData.substring(i, i + chunk));
      }

      //Loop through chunks, leaving out the header chunk
      for(var i=2;i<=chunkSize;i++) {

        //Create random number for the glitch decision
        var glitchRand =(Math.random()*100 + 1) | 0;

        //create random numbers for selection of the glitch characters
        var char1Rand = (Math.random()*glitchChars.length) | 0;
        var char2Rand = (Math.random()*glitchChars.length) | 0;

        if (char2Rand === char1Rand) {
          char2Rand = "9";
        }

        //If random number is odd
        if(glitchRand % 2) {
          //glitch the chunk
          chunks[i] = chunks[i].replace(glitchChars[char1Rand],glitchChars[char2Rand]);
        }

      } //End chunk loop

      //Base64 encode the glitched data
      var base64data = btoa(chunks.join(''));

      //Put the glitched image into the glitched canvas
      glitched_img = new Image();
      glitched_img.src = 'data:image/jpeg;base64,' + base64data;
      return glitched_img.onload = function() {
        return callback(this);
      };
    }


    if (Services.Browser.isChrome()) {
      new AppController();
    } else {
      alert("This page only supports Google Chrome, version 29 or higher.");
    }
  </script>
</body>
</html>
